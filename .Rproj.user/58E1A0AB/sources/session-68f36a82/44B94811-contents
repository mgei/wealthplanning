wealth0_out <- c(); wealth0_out[1] <- wealth0
cash0_out <- c(); cash0_out[1] <- max(wealth0*cash$percentage, min(cash$amount, wealth0), 0)
investment0_out <- matrix(nrow = length(timesteps$timestep), ncol = length(investment))
investment0_out[1,] <- sapply(investment, function(item) max(item$amount, item$percentage*wealth0))
# complete `age` in timesteps (if it's not set)
if (length(timesteps$age) < length(timesteps$timestep)) {
  timesteps$age <- rep(NA, length(timesteps$timestep))
}
# name investments (if some are not set)
counter <- 1
investment_names <- sapply(investment, function(item) {
  if (is.null(item$name)) {
    name <- paste("name", counter, sep = "")
    counter <<- counter + 1
    return(name)
  } else {
    return(item$name)
  }
})
colnames(investment0_out) <- investment_names
# use same names for liquidation also
liquidation_out <- matrix(nrow = length(timesteps$timestep), ncol = length(investment))
colnames(liquidation_out) <- investment_names
# for later use
income_out <- c(); income_out[1] <- income$income0
expense_out <- c(); expense_out[1] <- expense$expense0
capincome_out <- c()
roi_out <- investment0_out
roi_out[] <- NA
wealth1_out <- c()
cash1_out <- c()
wealth1_out <- c()
investment1_out <- investment0_out
investment1_out[] <- NA

# random returns
p_rets <- matrix(rnorm(n = 2*length(timesteps$timestep),
                       mean = sapply(investment, function(item) item$exp_pret),
                       sd = sapply(investment, function(item) item$exp_psd)),
                 ncol = ncol(investment0_out), byrow = T)
d_rets <- matrix(rnorm(n = 2*length(timesteps$timestep),
                       mean = sapply(investment, function(item) item$exp_dret),
                       sd = sapply(investment, function(item) item$exp_dsd)),
                 ncol = ncol(investment0_out), byrow = T)

for (i in 1:length(timesteps$timestep)) {
  if (i > 1) {
    investment0_out[i,] <- investment1_out[i-1,]
    cash0_out[i] <- cash1_out[i-1]
    wealth0_out[i] <- wealth1_out[i-1]
    
    income_out[i] <- income_out[i-1]*(1+income$exp_increase)
    expense_out[i] <- expense_out[i-1]*(1+expense$exp_inflation)
  }
  
  # remove from investment if wealth smaller than investment amounts
  excess <- sum(investment0_out[i,]) - (wealth0_out[i] - cash0_out[i])
  if (excess > 0) {
    for (k in ncol(investment0_out):1) {
      reduction <- min(excess, investment0_out[i,k])
      investment0_out[i,k] <- investment0_out[i,k] - reduction
      excess <- excess - reduction
      if (excess <= 0) break
    }
  }
  
  capincome_out[i] <- sum(investment0_out[i,] * d_rets[i,])
  roi_out[i,] <- investment0_out[i,] * p_rets[i,]
  
  cash1_out[i] <- cash0_out[i] + income_out[i] + capincome_out[i] - expense_out[i]
  investment1_out[i,] <- investment0_out[i,] + roi_out[i]
  
  wealth1_out[i] <- cash1_out[i] + sum(investment1_out[i,])
}